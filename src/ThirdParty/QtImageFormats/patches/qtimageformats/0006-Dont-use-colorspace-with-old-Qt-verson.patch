From 30c64f46534cf8f21d33ece60e8f114513267488 Mon Sep 17 00:00:00 2001
From: Peter Zhigalov <peter.zhigalov@gmail.com>
Date: Sun, 17 Nov 2019 01:42:45 +0700
Subject: [PATCH 6/7] Dont use colorspace with old Qt verson

---
 src/plugins/imageformats/tiff/qtiffhandler.cpp | 6 ++++++
 src/plugins/imageformats/webp/qwebphandler.cpp | 6 ++++++
 src/plugins/imageformats/webp/qwebphandler_p.h | 4 ++++
 3 files changed, 16 insertions(+)

diff --git a/src/plugins/imageformats/tiff/qtiffhandler.cpp b/src/plugins/imageformats/tiff/qtiffhandler.cpp
index e13fc74..5d73cc6 100644
--- a/src/plugins/imageformats/tiff/qtiffhandler.cpp
+++ b/src/plugins/imageformats/tiff/qtiffhandler.cpp
@@ -39,7 +39,9 @@
 
 #include "qtiffhandler_p.h"
 
+#if (QT_VERSION >= QT_VERSION_CHECK(5, 14, 0))
 #include <qcolorspace.h>
+#endif
 #include <qdebug.h>
 #include <qfloat16.h>
 #include <qimage.h>
@@ -594,6 +596,7 @@ bool QTiffHandler::read(QImage *image)
         }
     }
 
+#if (QT_VERSION >= QT_VERSION_CHECK(5, 14, 0))
     uint32_t count;
     void *profile;
     if (TIFFGetField(tiff, TIFFTAG_ICCPROFILE, &count, &profile)) {
@@ -602,6 +605,7 @@ bool QTiffHandler::read(QImage *image)
     }
     // We do not handle colorimetric metadat not on ICC profile form, it seems to be a lot
     // less common, and would need additional API in QColorSpace.
+#endif
 
     return true;
 }
@@ -709,6 +713,7 @@ bool QTiffHandler::write(const QImage &image)
         TIFFClose(tiff);
         return false;
     }
+#if (QT_VERSION >= QT_VERSION_CHECK(5, 14, 0))
     // set color space
     if (image.colorSpace().isValid()) {
         QByteArray iccProfile = image.colorSpace().iccProfile();
@@ -717,6 +722,7 @@ bool QTiffHandler::write(const QImage &image)
             return false;
         }
     }
+#endif
     // configure image depth
     const QImage::Format format = image.format();
     if (format == QImage::Format_Mono || format == QImage::Format_MonoLSB) {
diff --git a/src/plugins/imageformats/webp/qwebphandler.cpp b/src/plugins/imageformats/webp/qwebphandler.cpp
index 23108ce..6cc5cd2 100644
--- a/src/plugins/imageformats/webp/qwebphandler.cpp
+++ b/src/plugins/imageformats/webp/qwebphandler.cpp
@@ -171,6 +171,7 @@ bool QWebpHandler::read(QImage *image)
 
     QRect prevFrameRect;
     if (m_iter.frame_num == 0) {
+#if (QT_VERSION >= QT_VERSION_CHECK(5, 14, 0))
         // Read global meta-data chunks first
         WebPChunkIterator metaDataIter;
         if ((m_formatFlags & ICCP_FLAG) && WebPDemuxGetChunk(m_demuxer, "ICCP", 1, &metaDataIter)) {
@@ -183,6 +184,7 @@ bool QWebpHandler::read(QImage *image)
             // ### consider parsing EXIF and/or XMP metadata too.
             WebPDemuxReleaseChunkIterator(&metaDataIter);
         }
+#endif
 
         // Go to first frame
         if (!WebPDemuxGetFrame(m_demuxer, 1, &m_iter))
@@ -246,7 +248,9 @@ bool QWebpHandler::read(QImage *image)
 
         *image = *m_composited;
     }
+#if (QT_VERSION >= QT_VERSION_CHECK(5, 14, 0))
     image->setColorSpace(m_colorSpace);
+#endif
 
     return true;
 }
@@ -329,6 +333,7 @@ bool QWebpHandler::write(const QImage &image)
     }
 
     bool res = false;
+#if (QT_VERSION >= QT_VERSION_CHECK(5, 14, 0))
     if (image.colorSpace().isValid()) {
         int copy_data = 0;
         WebPMux *mux = WebPMuxNew();
@@ -368,6 +373,7 @@ bool QWebpHandler::write(const QImage &image)
         }
         WebPMuxDelete(mux);
     }
+#endif
     if (!res) {
         res = (writer.size ==
                    static_cast<size_t>(device()->write(reinterpret_cast<const char *>(writer.mem), writer.size)));
diff --git a/src/plugins/imageformats/webp/qwebphandler_p.h b/src/plugins/imageformats/webp/qwebphandler_p.h
index 87ce1b7..9ae663e 100644
--- a/src/plugins/imageformats/webp/qwebphandler_p.h
+++ b/src/plugins/imageformats/webp/qwebphandler_p.h
@@ -41,7 +41,9 @@
 #define QWEBPHANDLER_P_H
 
 #include <QtGui/qcolor.h>
+#if (QT_VERSION >= QT_VERSION_CHECK(5, 14, 0))
 #include <QtGui/qcolorspace.h>
+#endif
 #include <QtGui/qimage.h>
 #include <QtGui/qimageiohandler.h>
 #include <QtCore/qbytearray.h>
@@ -95,7 +97,9 @@ private:
     WebPData m_webpData;
     WebPDemuxer *m_demuxer;
     WebPIterator m_iter;
+#if (QT_VERSION >= QT_VERSION_CHECK(5, 14, 0))
     QColorSpace m_colorSpace;
+#endif
     QImage *m_composited;   // For animation frames composition
 };
 
-- 
2.33.1

